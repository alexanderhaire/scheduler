<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Grand Villa — App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 2rem; }
    button { padding:.5rem .8rem; border-radius:.4rem; border:1px solid #ddd; background:#f9f9f9; cursor:pointer; }
    input, select { padding:.4rem .5rem; border-radius:.3rem; border:1px solid #ddd; }
    .row { display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; }
    .card { border:1px solid #eee; padding:1rem; border-radius:.6rem; margin-top:1rem; }
    code { background:#f3f3f3; padding:.2rem .35rem; border-radius:.3rem; }
  </style>
</head>
<body>
  <h1>Grand Villa Scheduler</h1>
  <div id="auth" class="card">Loading…</div>

  <div class="card">
    <h2>Find soonest 5-minute slot</h2>
    <div class="row">
      <label>From (ISO, optional): <input id="fromIso" placeholder="(blank = now)" /></label>
      <button onclick="findSoonest()">Find</button>
    </div>
    <p id="soonest"></p>
  </div>

  <div class="card">
    <h2>Book a slot</h2>
    <div class="row">
      <label>requestedStartIso: <input id="reqIso" size="28" placeholder="Use a value from 'Find'"/></label>
      <label>Email (optional invitee): <input id="email" placeholder="someone@example.com"/></label>
      <label>Label (optional): <input id="label" placeholder="tour, call, etc."/></label>
      <label>TZ: 
        <input id="tz" value="America/New_York"/>
      </label>
      <button onclick="book()">Book</button>
    </div>
    <p id="bookResult"></p>
  </div>

  <script>
    async function getJSON(url, opts) {
      const r = await fetch(url, { credentials: 'include', ...opts });
      if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
      return r.json();
    }

    async function showAuth() {
      try {
        const me = await getJSON('/me');
        document.getElementById('auth').innerHTML =
          `<strong>Signed in</strong><br/>User ID: <code>${me.userId}</code><br/>Email: <code>${me.email ?? '(none)'}</code>
           <div style="margin-top:.5rem">
             <a href="/logout">Log out</a>
           </div>`;
      } catch {
        document.getElementById('auth').innerHTML =
          `Not signed in. <a href="/auth/google?next=/app.html">Sign in with Google</a>`;
      }
    }

    async function findSoonest() {
      try {
        const from = document.getElementById('fromIso').value.trim();
        const url = from ? `/v1/availability/soonest?from=${encodeURIComponent(from)}` : '/v1/availability/soonest';
        const data = await getJSON(url);
        document.getElementById('soonest').textContent =
          `Soonest: ${data.startIso} → ${data.endIso} (${data.slotMinutes} minutes)`;
        // pre-fill the booking input
        document.getElementById('reqIso').value = data.startIso;
      } catch (e) {
        document.getElementById('soonest').textContent = `Error: ${e.message}`;
      }
    }

    async function book() {
      const requestedStartIso = document.getElementById('reqIso').value.trim();
      const email = document.getElementById('email').value.trim();
      const label = document.getElementById('label').value.trim();
      const tz = document.getElementById('tz').value.trim();

      const body = { requestedStartIso };
      if (email) body.email = email;
      if (label) body.label = label;
      if (tz) body.tz = tz;

      try {
        const data = await getJSON('/v1/meetings', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });
        document.getElementById('bookResult').innerHTML =
          `Booked: <code>${data.scheduledStartIso}</code> → <code>${data.scheduledEndIso}</code>
           ${data.bumpedFromRequested ? ' (bumped)' : ''}
           ${data.htmlLink ? ` — <a href="${data.htmlLink}" target="_blank" rel="noreferrer">Open in Google Calendar</a>` : ''}`;
      } catch (e) {
        document.getElementById('bookResult').textContent = `Error: ${e.message}`;
      }
    }

    showAuth();
  </script>
</body>
</html>
